<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./stylesheets/Signup.css">
    <style>
        .terms label{
            display: flex;
        }
    </style>
</head>
<body>
    <div id="container">
        <% if(err.length>0){ %>
            <div class="err flash-message"> <%= err %> </div> 
            <%}else {%>
                <% } %>
        <h1>Register</h1>
        <form action="/register" method="post" id="Sign-up">
            <div class="username">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" placeholder="Enter Username" required>
            </div>
            <br>
            <div class="email">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" placeholder="Enter Email" required>
            </div>
            <br>
            <div class="password">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" placeholder="Enter Password" required>
            </div>
            <br>
            <input type="hidden" id="fcmToken" name="fcmToken"> <!-- Hidden field for FCM Token -->
            
            <div class="terms">
                <input type="radio" name="Terms" id="terms" required>
                <label for="terms"><p class="aware">By clicking this, you agree to the
                    <a href="/Terms-&-condition"><span>Terms & Conditions</span></a>
                    <a href="/Privacy-Policy">Privacy Policy</a></p></label>
            </div>
            <br>
            <button type="submit">Register</button>
            <a href="/login">Login</a>
        </form>        
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-messaging.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyAt9ZJs2CBEKFOK_T72QIQjVlidoBgiY-Q",
            authDomain: "clartalk-94a92.firebaseapp.com",
            databaseURL: "https://clartalk-94a92-default-rtdb.firebaseio.com",
            projectId: "clartalk-94a92",
            storageBucket: "clartalk-94a92.firebasestorage.app",
            messagingSenderId: "220220136589",
            appId: "1:220220136589:web:80ce8c1c77fb718c4bd6c4",
            measurementId: "G-SXR988HK5W"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
    
        document.getElementById("Sign-up").addEventListener("submit", async function (event) {
            event.preventDefault(); // Prevent form submission until token is generated

            try {
                const permission = await Notification.requestPermission()

                if (permission === "granted") {
                    const token = await getToken(messaging, { vapidKey: "BDhQxlMBmyq4wfmcEu3QXV3k_b7rhPdyoE9C0q3ftnNe_bC9tRnBZpmwBAzj72-9UJcevR9GuYjCXfpd3Y13uiU" });
                if (token) {
                    console.log("FCM Token:", token);
                    document.getElementById("fcmToken").value = token; // Store token in hidden field
                    document.getElementById("Sign-up").submit(); // Submit form after token is set
                } else {
                    console.log("No registration token available.");
                    res.send("hello");
                }
                }
            } catch (error) {
                console.error("Error retrieving token:", error);
                document.getElementById("Sign-up").submit(); // Submit form even if token retrieval fails
            }
            
        });
    </script>    
</body>
</html>